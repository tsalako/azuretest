<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Review Llama</title>

    <link rel="shortcut icon" href="../media/kuzco_cursed.png">
    
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href="../css/main.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<style>
    ul {
        list-style-type: none;
        padding-left:5px;
    }
    ul,ol {
        margin-bottom: 0px;
    }
</style>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="dashboard.html">Review Llama</a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li><a href="#"><i class="fa fa-cog fa-spin"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li><a href="../login.html"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                    <!-- /.dropdown-user -->
                </li>
                <!-- /.dropdown -->
            </ul>
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li>
                            <a href="dashboard.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                        <li>
                            <a href="adminManager.html"><i class="fa fa-gavel fa-fw"></i> Admin Manager</a>
                        </li>
                        <li>
                            <a href="groupManager.html"><i class="fa fa-cogs fa-fw"></i> Group Manager</a>
                        </li>
                        <li>
                            <a href="reports.html"><i class="fa fa-file fa-fw"></i> Reports</a>
                        </li>
                        <li>
                            <a href="assessments.html"><i class="fa fa-edit fa-fw"></i> Assessments</a>
                        </li>
                        <li>
                            <a href="stats.html"><i class="fa fa-area-chart fa-fw"></i> Statistics</a>
                        </li>
                        <li>
                            <a href="../forum.html"><i class="fa fa-users fa-fw"></i> Da Forum</a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">Group Manager</h1>
                    </div>
                    <!-- /.col-lg-12 -->
                </div>
                <!-- /.row -->
                <div class="row">
                    <div class="col-lg-10 col-md-10 left">
                        <!-- <div class="col-lg-2 col-md-4 '+offset+'">
                            <div class="panel '+color+'-border">
                                '<div >
                                    <label>Cool Name</label>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="'+color+'-div">
                                    <ul id="group'+(i+1)+'" class="connectedSortable">
                                        <li class="item'+count+'">NUM '+(count++)+'</li>
                                        <li class="item'+count+'">NUM '+(count++)+'</li>
                                        <li class="item'+count+'">NUM '+(count++)+'</li>
                                    </ul>
                                </div>
                                <div >
                                    <p>Group '+(i+1)+'</p>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div> -->
                    </div>
                    <div class="col-lg-2 col-md-2 right">
                        <div class="panel text-center">
                            <div class="panel">
                                <label>Drag/drop to edit!</label>
                                <button type="scramble" class="btn btn-default">Scramble!!!</button>
                            </div>
                            <div class="panel">
                                <label>Upload List</label>
                                <div>
                                    <button class="btn btn-default">
                                        <label class="upload"><span><i class="fa fa-upload "><input id="fileUploaded" type="file"></i></span></label>
                                    </button>      
                                    <p id="fileName">No file chosen<p>
                                </div>
                            </div>    
                            <div class="panel">
                                <button type="save" class="btn btn-default disabled">Save</button>  
                            </div> 
                        </div>
                    </div>
                </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../js/sb-admin-2.js"></script>

    <!-- Util Javascript -->
    <script src = "../js/util.js"></script>
</body>

<script>
$(function() {
    sendRequest('../php/UserService.php',
            loadGroups,
            'getAllGroups');
});

var loadGroups = function(response) {
    var RESET_PROGRAM = false;

    var listObj = groupListObjtoList(response.data);
    var userList = listObj.userList;
    var groupNames = listObj.groupNames;
    var PROGRAM_START = listObj.PROGRAM_START;

    var colors = ["blue", "green", "yellow", "red"];
    var count = 0;
    for(var i = 0; i < 20; i++){
        var name = groupNames[i]==null ? "&nbsp" : groupNames[i];
        var offset = (i%5==0 ) ? "col-lg-offset-1" : "";
        var color = colors[Math.floor(i/5)];
        if(i%5==0){
            $(".container-fluid .left")
            .append('<div class="row inner-row"></div>');
        }

        $(".container-fluid .left .inner-row").last()
            .append('<div class="col-lg-2 col-md-2 '+offset+'">'+
                        '<div class="panel '+color+'-border">'+
                            '<div >'+
                                '<label>'+name+'</label>'+
                                '<div class="clearfix"></div>'+
                            '</div>'+
                            '<div class="'+color+'-div">'+
                                '<ul id="group'+(i+1)+'" class="connectedSortable">'+
                                    '<li class="item'+count+'">'+userList[count++]+'</li>'+
                                    '<li class="item'+count+'">'+userList[count++]+'</li>'+
                                    '<li class="item'+count+'">'+userList[count++]+'</li>'+
                                '</ul>'+
                            '</div>'+
                            '<div >'+
                                '<p>Group '+(i+1)+'</p>'+
                                '<div class="clearfix"></div>'+
                            '</div>'+
                        '</div>'+
                    '</div>');
    }

    $( ".connectedSortable" ).sortable({
        connectWith: ".connectedSortable",
        remove: function(event, ui) {
                if(ui.item.index() != 0){
                    $(".black-border").removeClass("black-border");

                    var $currentItem = $(ui.item);
                    var $itemToSwap = $(ui.item).closest("ul").find("li:nth-child("+ui.item.index()+")");

                    var temp = $currentItem.text();
                    $currentItem.text($itemToSwap.text()).addClass("black-border");
                    $itemToSwap.text(temp).addClass("black-border");

                    window.onbeforeunload = function(){ return 'You have unsaved data.' }
                    $("button[type=save]").removeClass("disabled");
                }
                $(this).sortable('cancel');
        },
        placeholder: "ui-state-highlight",
        helper: function(event, ui) {
            $(ui).width($(ui).width());
            $(ui).height($(ui).height());
            ui.children().each(function() {
                $(this).width($(this).width());
            });
            return ui;
        }
    }).disableSelection();

    $("#fileUploaded").change(function() {
        //If it is the first time the program is run (no groups exist) dont prompt the user to see if they are sure.
        if(PROGRAM_START){
            var file = document.getElementById('fileUploaded').files[0];
                $("#fileName").text(file.name);
                
                if(file) {
                    var reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = function (e) {
                        userList = e.target.result.split("\n");
                        if(userList.length == 60){
                            for(var i = 0; i < userList.length; i++){
                                userList[i] = userList[i].trim();
                            }
                            displayListElements(userList);
                            RESET_PROGRAM = true;
                        } else {
                            alert("There was a problem loading the file. Ensure the file has exactly 60 usernames (one name per line).");
                        }
                    }
                }
        } else {
            if (confirm('Are you sure you want to change the registration list? Doing so will reset the whole system.')) {
                var file = document.getElementById('fileUploaded').files[0];
                $("#fileName").text(file.name);
                
                if(file) {
                    var reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = function (e) {
                        userList = e.target.result.split("\n");
                        if(userList.length == 60){
                            for(var i = 0; i < userList.length; i++){
                                userList[i] = userList[i].trim();
                            }
                            displayListElements(userList);
                            RESET_PROGRAM = true;
                        } else {
                            alert("There was a problem loading the file. Ensure the file has exactly 60 usernames (one name per line).");
                        }
                    }
                }
            } else {
                // Do nothing!
            }
        }
        
        
    });

    $("button[type=scramble]").click(function() {
        userList.sort(function() { return 0.5 - Math.random() });
        displayListElements(userList);
    });

    $("button[type=save]").click(function() {
        if(RESET_PROGRAM){
            if(PROGRAM_START){
                sendRequest('../php/UserService.php',
                    verifySave,
                    'createGroups',
                    {'groupList':listToGroupListObj(userList)});
            } else {
                if (confirm('Again. Are you sure? Saving now will reset the system.')) {
                    sendRequest('../php/UserService.php',
                        verifySave,
                        'createGroups',
                        {'groupList':listToGroupListObj(userList)});
                } else {
                    //alert('No save done');
                }
            }
            
        } else {
            sendRequest('../php/UserService.php',
                verifySave,
                'modifyGroups',
                {'groupList':listToGroupListObj(userList)});
        }
        
    });
}

function groupListObjtoList(groupList){
    var list = [];
    var groupNames = [];
    var PROGRAM_START = false;
    console.log(groupList);
    if(groupList.length == 0){
        PROGRAM_START = true;
        for(var i = 0; i < 20; i++){
            groupNames.push(null);
            for(var j = 0; j < 3; j++){
                list.push('&nbsp');
            }
        }
    } else {
        $.each(groupList, function(i, group) {
            groupNames.push(group.name);
            $.each(group.users, function(j, user) {
                list.push(user.username);
            });
        });
    }

    return {'userList':list, 'groupNames': groupNames, 'PROGRAM_START': PROGRAM_START};
}

function listToGroupListObj(list){
    var listCount = 0;
    var groupList = [];
    for(var i = 0; i < 20; i++){
        var groupNo = Math.floor(listCount / 3) + 1;
        var usersArray = [list[listCount++],
                          list[listCount++],
                          list[listCount++]];
        var groupObj = {groupNo: revertGroupNo(groupNo),
                        assignedBy: 1, //admin number
                        usernames: usersArray};

        groupList.push(groupObj);
    }
    return groupList;
}

var displayListElements = function(list){
    $(".black-border").removeClass("black-border");
    $("button[type=save]").removeClass("disabled");
    window.onbeforeunload = function(){ return 'You have unsaved data.' }
    $.each(list, function(i , element) {
        $(".item"+i+"").text(element);
    });
}

var verifySave = function(response){
    $(".black-border").removeClass("black-border");
    $("button[type=save]").addClass("disabled");
    window.onbeforeunload = null;
    alert(response.data);
}

</script>

</html>
